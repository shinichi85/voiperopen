; ########################################################################################################
; FROM-PSTN
; ########################################################################################################

[from-pstn]
include => from-pstn-custom                                                         ; create this context in extensions_custom.conf to include customizations
include => ext-did
include => from-pstn-timecheck                                                        ; this has to be included otherwise it overrides ext-did
exten => fax,1,Goto(ext-fax,in_fax,1)

[from-pstn-timecheck]
exten => _X.,1,Goto(s,1)                                                            ; catch-all matching for calls that have DID info (if a DID route hasn't matched them)
exten => s,1,GotoIf($["${IN_OVERRIDE}" = "forcereghours" | "${DB(IN_OVERRIDE_1/INCOMING)}" ="forcereghours" ]?from-pstn-reghours,s,1:)
exten => s,2,GotoIf($["${IN_OVERRIDE}" = "forceafthours" | "${DB(IN_OVERRIDE_1/INCOMING)}" ="forceafthours" ]?from-pstn-afthours,s,1:)
exten => s,3,GotoIf($["${IN_OVERRIDE}" = "forceholiday" | "${DB(IN_OVERRIDE_1/INCOMING)}" ="forceholiday" ]?from-pstn-holiday,s,1:)

exten => s,4,GotoIf($["foo${REGTIME}foo${REGDAYS}foo${REGMONTHS}" = "foofoofoo"]?6:5)
exten => s,5,GotoIfTime(${REGTIME}|${REGDAYS}|*|${REGMONTHS}?from-pstn-reghours,s,1:)
exten => s,6,GotoIf($["foo${REGTIME2}foo${REGDAYS2}foo${REGMONTHS2}" = "foofoofoo"]?8:7)
exten => s,7,GotoIfTime(${REGTIME2}|${REGDAYS2}|*|${REGMONTHS2}?from-pstn-reghours,s,1:)
exten => s,8,GotoIf($["foo${REGTIME3}foo${REGDAYS3}foo${REGMONTHS3}" = "foofoofoo"]?10:9)
exten => s,9,GotoIfTime(${REGTIME3}|${REGDAYS3}|*|${REGMONTHS3}?from-pstn-reghours,s,1:)
exten => s,10,GotoIf($["foo${REGTIME4}foo${REGDAYS4}foo${REGMONTHS4}" = "foofoofoo"]?12:11)
exten => s,11,GotoIfTime(${REGTIME4}|${REGDAYS4}|*|${REGMONTHS4}?from-pstn-reghours,s,1:)

exten => s,12,Goto(from-pstn-afthours,s,1)

[from-pstn-reghours]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-reghours-nofax,s,1:2)        ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${INCOMING})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${INCOMING:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${INCOMING:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${INCOMING:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${INCOMING:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${INCOMING:4},1)
exten => s,21,Goto(${INCOMING},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-reghours-nofax]
exten => s,1,Set(intype=${INCOMING})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${INCOMING:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${INCOMING:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${INCOMING:8},1)
exten => s,9,GotoIf($["${intype}" = "QUE"]?10:13)                                     ; queue
exten => s,10,Answer                                                                ; answer call before queue
exten => s,11,Wait(1)
exten => s,12,Goto(ext-queues,${INCOMING:4},1)
exten => s,13,GotoIf($["${intype}" = "MIS"]?14:17)                                     ; queue
exten => s,14,Answer                                                                ; answer call before queue
exten => s,15,Wait(1)
exten => s,16,Goto(ext-miscdests,${INCOMING:4},1)
exten => s,17,Answer                                                                ; answer call before auto attendant
exten => s,18,Wait(1)
exten => s,19,Goto(${INCOMING},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-afthours]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-afthours-nofax,s,1:2)        ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${AFTER_INCOMING})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${AFTER_INCOMING:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${AFTER_INCOMING:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${AFTER_INCOMING:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${AFTER_INCOMING:4},1)
exten => s,21,GotoIf($["${intype}" = "DIALFAX"]?22:24)
exten => s,22,Wait(3)
exten => s,23,Goto(ext-test,${AFTER_INCOMING:8},1)
exten => s,24,Goto(${AFTER_INCOMING},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-afthours-nofax]
exten => s,1,Set(intype=${AFTER_INCOMING})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${AFTER_INCOMING:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${AFTER_INCOMING:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${AFTER_INCOMING:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${AFTER_INCOMING:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${AFTER_INCOMING:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${AFTER_INCOMING},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-holiday]
exten => s,1,Set(intype=${HOLIDAY_INCOMING})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${HOLIDAY_INCOMING:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${HOLIDAY_INCOMING:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${HOLIDAY_INCOMING:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${HOLIDAY_INCOMING:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${HOLIDAY_INCOMING:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${HOLIDAY_INCOMING:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${HOLIDAY_INCOMING},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

; ########################################################################################################
; FROM-PSTN-1
; ########################################################################################################

[from-pstn-1]
include => from-pstn-custom-1                                                       ; create this context in extensions_custom.conf to include customizations
include => ext-did
include => from-pstn-timecheck_1                                                    ; this has to be included otherwise it overrides ext-did
exten => fax,1,Goto(ext-fax,in_fax,1)

[from-pstn-timecheck_1]
exten => _X.,1,Goto(s,1)                                                            ; catch-all matching for calls that have DID info (if a DID route hasn't matched them)
exten => s,1,GotoIf($["${IN_OVERRIDE_1}" = "forcereghours" | "${DB(IN_OVERRIDE_2/INCOMING)}" ="forcereghours" ]?from-pstn-reghours-1,s,1:)
exten => s,2,GotoIf($["${IN_OVERRIDE_1}" = "forceafthours" | "${DB(IN_OVERRIDE_2/INCOMING)}" ="forceafthours" ]?from-pstn-afthours-1,s,1:)
exten => s,3,GotoIf($["${IN_OVERRIDE_1}" = "forceholiday" | "${DB(IN_OVERRIDE_2/INCOMING)}" ="forceholiday" ]?from-pstn-holiday-1,s,1:)

exten => s,4,GotoIf($["foo${REGTIME_1}foo${REGDAYS_1}foo${REGMONTHS_1}" = "foofoofoo"]?6:5)
exten => s,5,GotoIfTime(${REGTIME_1}|${REGDAYS_1}|*|${REGMONTHS_1}?from-pstn-reghours-1,s,1:)
exten => s,6,GotoIf($["foo${REGTIME2_1}foo${REGDAYS2_1}foo${REGMONTHS2_1}" = "foofoofoo"]?8:7)
exten => s,7,GotoIfTime(${REGTIME2_1}|${REGDAYS2_1}|*|${REGMONTHS2_1}?from-pstn-reghours-1,s,1:)
exten => s,8,GotoIf($["foo${REGTIME3_1}foo${REGDAYS3_1}foo${REGMONTHS3_1}" = "foofoofoo"]?10:9)
exten => s,9,GotoIfTime(${REGTIME3_1}|${REGDAYS3_1}|*|${REGMONTHS3_1}?from-pstn-reghours-1,s,1:)
exten => s,10,GotoIf($["foo${REGTIME4_1}foo${REGDAYS4_1}foo${REGMONTHS4_1}" = "foofoofoo"]?12:11)
exten => s,11,GotoIfTime(${REGTIME4_1}|${REGDAYS4_1}|*|${REGMONTHS4_1}?from-pstn-reghours-1,s,1:)

exten => s,12,Goto(from-pstn-afthours-1,s,1)

[from-pstn-reghours-1]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-reghours-nofax-1,s,1:2)    ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${INCOMING_1})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${INCOMING_1:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${INCOMING_1:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${INCOMING_1:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${INCOMING_1:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${INCOMING_1:4},1)
exten => s,21,Goto(${INCOMING_1},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-reghours-nofax-1]
exten => s,1,Set(intype=${INCOMING_1})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${INCOMING_1:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${INCOMING_1:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${INCOMING_1:8},1)
exten => s,9,GotoIf($["${intype}" = "QUE"]?10:13)                                     ; queue
exten => s,10,Answer                                                                ; answer call before queue
exten => s,11,Wait(1)
exten => s,12,Goto(ext-queues,${INCOMING_1:4},1)
exten => s,13,GotoIf($["${intype}" = "MIS"]?14:17)                                     ; queue
exten => s,14,Answer                                                                ; answer call before queue
exten => s,15,Wait(1)
exten => s,16,Goto(ext-miscdests,${INCOMING_1:4},1)
exten => s,17,Answer                                                                ; answer call before auto attendant
exten => s,18,Wait(1)
exten => s,19,Goto(${INCOMING_1},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-afthours-1]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-afthours-nofax-1,s,1:2)    ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${AFTER_INCOMING_1})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${AFTER_INCOMING_1:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${AFTER_INCOMING_1:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING_1:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${AFTER_INCOMING_1:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${AFTER_INCOMING_1:4},1)
exten => s,21,GotoIf($["${intype}" = "DIALFAX"]?22:24)
exten => s,22,Wait(3)
exten => s,23,Goto(ext-test,${AFTER_INCOMING_1:8},1)
exten => s,24,Goto(${AFTER_INCOMING_1},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-afthours-nofax-1]
exten => s,1,Set(intype=${AFTER_INCOMING_1})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${AFTER_INCOMING_1:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${AFTER_INCOMING_1:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${AFTER_INCOMING_1:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${AFTER_INCOMING_1:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING_1:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${AFTER_INCOMING_1:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${AFTER_INCOMING_1},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-holiday-1]
exten => s,1,Set(intype=${HOLIDAY_INCOMING_1})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${HOLIDAY_INCOMING_1:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${HOLIDAY_INCOMING_1:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${HOLIDAY_INCOMING_1:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${HOLIDAY_INCOMING_1:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${HOLIDAY_INCOMING_1:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${HOLIDAY_INCOMING_1:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${HOLIDAY_INCOMING_1},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

; ########################################################################################################
; FROM-PSTN-2
; ########################################################################################################

[from-pstn-2]
include => from-pstn-custom-2                                                       ; create this context in extensions_custom.conf to include customizations
include => ext-did
include => from-pstn-timecheck_2                                                    ; this has to be included otherwise it overrides ext-did
exten => fax,1,Goto(ext-fax,in_fax,1)

[from-pstn-timecheck_2]
exten => _X.,1,Goto(s,1)                                                            ; catch-all matching for calls that have DID info (if a DID route hasn't matched them)
exten => s,1,GotoIf($["${IN_OVERRIDE_2}" = "forcereghours" | "${DB(IN_OVERRIDE_3/INCOMING)}" ="forcereghours" ]?from-pstn-reghours-2,s,1:)
exten => s,2,GotoIf($["${IN_OVERRIDE_2}" = "forceafthours" | "${DB(IN_OVERRIDE_3/INCOMING)}" ="forceafthours" ]?from-pstn-afthours-2,s,1:)
exten => s,3,GotoIf($["${IN_OVERRIDE_2}" = "forceholiday" | "${DB(IN_OVERRIDE_3/INCOMING)}" ="forceholiday" ]?from-pstn-holiday-2,s,1:)

exten => s,4,GotoIf($["foo${REGTIME_2}foo${REGDAYS_2}foo${REGMONTHS_2}" = "foofoofoo"]?6:5)
exten => s,5,GotoIfTime(${REGTIME_2}|${REGDAYS_2}|*|${REGMONTHS_2}?from-pstn-reghours-2,s,1:)
exten => s,6,GotoIf($["foo${REGTIME2_2}foo${REGDAYS2_2}foo${REGMONTHS2_2}" = "foofoofoo"]?8:7)
exten => s,7,GotoIfTime(${REGTIME2_2}|${REGDAYS2_2}|*|${REGMONTHS2_2}?from-pstn-reghours-2,s,1:)
exten => s,8,GotoIf($["foo${REGTIME3_2}foo${REGDAYS3_2}foo${REGMONTHS3_2}" = "foofoofoo"]?10:9)
exten => s,9,GotoIfTime(${REGTIME3_2}|${REGDAYS3_2}|*|${REGMONTHS3_2}?from-pstn-reghours-2,s,1:)
exten => s,10,GotoIf($["foo${REGTIME4_2}foo${REGDAYS4_2}foo${REGMONTHS4_2}" = "foofoofoo"]?12:11)
exten => s,11,GotoIfTime(${REGTIME4_2}|${REGDAYS4_2}|*|${REGMONTHS4_2}?from-pstn-reghours-2,s,1:)

exten => s,12,Goto(from-pstn-afthours-2,s,1)

[from-pstn-reghours-2]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-reghours-nofax-2,s,1:2)    ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${INCOMING_2})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${INCOMING_2:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${INCOMING_2:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${INCOMING_2:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${INCOMING_2:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${INCOMING_2:4},1)
exten => s,21,Goto(${INCOMING_2},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-reghours-nofax-2]
exten => s,1,Set(intype=${INCOMING_2})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${INCOMING_2:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${INCOMING_2:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${INCOMING_2:8},1)
exten => s,9,GotoIf($["${intype}" = "QUE"]?10:13)                                     ; queue
exten => s,10,Answer                                                                ; answer call before queue
exten => s,11,Wait(1)
exten => s,12,Goto(ext-queues,${INCOMING_2:4},1)
exten => s,13,GotoIf($["${intype}" = "MIS"]?14:17)                                     ; queue
exten => s,14,Answer                                                                ; answer call before queue
exten => s,15,Wait(1)
exten => s,16,Goto(ext-miscdests,${INCOMING_2:4},1)
exten => s,17,Answer                                                                ; answer call before auto attendant
exten => s,18,Wait(1)
exten => s,19,Goto(${INCOMING_2},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-afthours-2]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-afthours-nofax-2,s,1:2)    ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${AFTER_INCOMING_2})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${AFTER_INCOMING_2:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${AFTER_INCOMING_2:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING_2:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${AFTER_INCOMING_2:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${AFTER_INCOMING_2:4},1)
exten => s,21,GotoIf($["${intype}" = "DIALFAX"]?22:24)
exten => s,22,Wait(3)
exten => s,23,Goto(ext-test,${AFTER_INCOMING_2:8},1)
exten => s,24,Goto(${AFTER_INCOMING_2},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-afthours-nofax-2]
exten => s,1,Set(intype=${AFTER_INCOMING_2})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${AFTER_INCOMING_2:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${AFTER_INCOMING_2:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${AFTER_INCOMING_2:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${AFTER_INCOMING_2:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING_2:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${AFTER_INCOMING_2:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${AFTER_INCOMING_2},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-holiday-2]
exten => s,1,Set(intype=${HOLIDAY_INCOMING_2})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${HOLIDAY_INCOMING_2:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${HOLIDAY_INCOMING_2:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${HOLIDAY_INCOMING_2:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${HOLIDAY_INCOMING_2:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${HOLIDAY_INCOMING_2:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${HOLIDAY_INCOMING_2:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${HOLIDAY_INCOMING_2},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

; ########################################################################################################
; FROM-PSTN-3
; ########################################################################################################

[from-pstn-3]
include => from-pstn-custom-3                                                       ; create this context in extensions_custom.conf to include customizations
include => ext-did
include => from-pstn-timecheck_3                                                    ; this has to be included otherwise it overrides ext-did
exten => fax,1,Goto(ext-fax,in_fax,1)

[from-pstn-timecheck_3]
exten => _X.,1,Goto(s,1)                                                            ; catch-all matching for calls that have DID info (if a DID route hasn't matched them)
exten => s,1,GotoIf($["${IN_OVERRIDE_3}" = "forcereghours" | "${DB(IN_OVERRIDE_4/INCOMING)}" ="forcereghours" ]?from-pstn-reghours-3,s,1:)
exten => s,2,GotoIf($["${IN_OVERRIDE_3}" = "forceafthours" | "${DB(IN_OVERRIDE_4/INCOMING)}" ="forceafthours" ]?from-pstn-afthours-3,s,1:)
exten => s,3,GotoIf($["${IN_OVERRIDE_3}" = "forceholiday" | "${DB(IN_OVERRIDE_4/INCOMING)}" ="forceholiday" ]?from-pstn-holiday-3,s,1:)

exten => s,4,GotoIf($["foo${REGTIME_3}foo${REGDAYS_3}foo${REGMONTHS_3}" = "foofoofoo"]?6:5)
exten => s,5,GotoIfTime(${REGTIME_3}|${REGDAYS_3}|*|${REGMONTHS_3}?from-pstn-reghours-3,s,1:)
exten => s,6,GotoIf($["foo${REGTIME2_3}foo${REGDAYS2_3}foo${REGMONTHS2_3}" = "foofoofoo"]?8:7)
exten => s,7,GotoIfTime(${REGTIME2_3}|${REGDAYS2_3}|*|${REGMONTHS2_3}?from-pstn-reghours-3,s,1:)
exten => s,8,GotoIf($["foo${REGTIME3_3}foo${REGDAYS3_3}foo${REGMONTHS3_3}" = "foofoofoo"]?10:9)
exten => s,9,GotoIfTime(${REGTIME3_3}|${REGDAYS3_3}|*|${REGMONTHS3_3}?from-pstn-reghours-3,s,1:)
exten => s,10,GotoIf($["foo${REGTIME4_3}foo${REGDAYS4_3}foo${REGMONTHS4_3}" = "foofoofoo"]?12:11)
exten => s,11,GotoIfTime(${REGTIME4_3}|${REGDAYS4_3}|*|${REGMONTHS4_3}?from-pstn-reghours-3,s,1:)

exten => s,12,Goto(from-pstn-afthours-3,s,1)

[from-pstn-reghours-3]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-reghours-nofax-3,s,1:2)    ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${INCOMING_3})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${INCOMING_3:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${INCOMING_3:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${INCOMING_3:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${INCOMING_3:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${INCOMING_3:4},1)
exten => s,21,Goto(${INCOMING_3},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-reghours-nofax-3]
exten => s,1,Set(intype=${INCOMING_3})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${INCOMING_3:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${INCOMING_3:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${INCOMING_3:8},1)
exten => s,9,GotoIf($["${intype}" = "QUE"]?10:13)                                     ; queue
exten => s,10,Answer                                                                ; answer call before queue
exten => s,11,Wait(1)
exten => s,12,Goto(ext-queues,${INCOMING_3:4},1)
exten => s,13,GotoIf($["${intype}" = "MIS"]?14:17)                                     ; queue
exten => s,14,Answer                                                                ; answer call before queue
exten => s,15,Wait(1)
exten => s,16,Goto(ext-miscdests,${INCOMING_3:4},1)
exten => s,17,Answer                                                                ; answer call before auto attendant
exten => s,18,Wait(1)
exten => s,19,Goto(${INCOMING_3},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-afthours-3]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-afthours-nofax-3,s,1:2)    ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${AFTER_INCOMING_3})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${AFTER_INCOMING_3:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${AFTER_INCOMING_3:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING_3:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${AFTER_INCOMING_3:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${AFTER_INCOMING_3:4},1)
exten => s,21,GotoIf($["${intype}" = "DIALFAX"]?22:24)
exten => s,22,Wait(3)
exten => s,23,Goto(ext-test,${AFTER_INCOMING_3:8},1)
exten => s,24,Goto(${AFTER_INCOMING_3},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-afthours-nofax-3]
exten => s,1,Set(intype=${AFTER_INCOMING_3})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${AFTER_INCOMING_3:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${AFTER_INCOMING_3:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${AFTER_INCOMING_3:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${AFTER_INCOMING_3:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING_3:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${AFTER_INCOMING_3:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${AFTER_INCOMING_3},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-holiday-3]
exten => s,1,Set(intype=${HOLIDAY_INCOMING_3})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${HOLIDAY_INCOMING_3:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${HOLIDAY_INCOMING_3:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${HOLIDAY_INCOMING_3:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${HOLIDAY_INCOMING_3:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${HOLIDAY_INCOMING_3:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${HOLIDAY_INCOMING_3:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${HOLIDAY_INCOMING_3},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

; ########################################################################################################
; FROM-PSTN-4
; ########################################################################################################

[from-pstn-4]
include => from-pstn-custom-4                                                       ; create this context in extensions_custom.conf to include customizations
include => ext-did
include => from-pstn-timecheck_4                                                    ; this has to be included otherwise it overrides ext-did
exten => fax,1,Goto(ext-fax,in_fax,1)

[from-pstn-timecheck_4]
exten => _X.,1,Goto(s,1)                                                            ; catch-all matching for calls that have DID info (if a DID route hasn't matched them)
exten => s,1,GotoIf($["${IN_OVERRIDE_4}" = "forcereghours" | "${DB(IN_OVERRIDE_5/INCOMING)}" ="forcereghours" ]?from-pstn-reghours-4,s,1:)
exten => s,2,GotoIf($["${IN_OVERRIDE_4}" = "forceafthours" | "${DB(IN_OVERRIDE_5/INCOMING)}" ="forceafthours" ]?from-pstn-afthours-4,s,1:)
exten => s,3,GotoIf($["${IN_OVERRIDE_4}" = "forceholiday" | "${DB(IN_OVERRIDE_5/INCOMING)}" ="forceholiday" ]?from-pstn-holiday-4,s,1:)

exten => s,4,GotoIf($["foo${REGTIME_4}foo${REGDAYS_4}foo${REGMONTHS_4}" = "foofoofoo"]?6:5)
exten => s,5,GotoIfTime(${REGTIME_4}|${REGDAYS_4}|*|${REGMONTHS_4}?from-pstn-reghours-4,s,1:)
exten => s,6,GotoIf($["foo${REGTIME2_4}foo${REGDAYS2_4}foo${REGMONTHS2_4}" = "foofoofoo"]?8:7)
exten => s,7,GotoIfTime(${REGTIME2_4}|${REGDAYS2_4}|*|${REGMONTHS2_4}?from-pstn-reghours-4,s,1:)
exten => s,8,GotoIf($["foo${REGTIME3_4}foo${REGDAYS3_4}foo${REGMONTHS3_4}" = "foofoofoo"]?10:9)
exten => s,9,GotoIfTime(${REGTIME3_4}|${REGDAYS3_4}|*|${REGMONTHS3_4}?from-pstn-reghours-4,s,1:)
exten => s,10,GotoIf($["foo${REGTIME4_4}foo${REGDAYS4_4}foo${REGMONTHS4_4}" = "foofoofoo"]?12:11)
exten => s,11,GotoIfTime(${REGTIME4_4}|${REGDAYS4_4}|*|${REGMONTHS4_4}?from-pstn-reghours-4,s,1:)

exten => s,12,Goto(from-pstn-afthours-4,s,1)

[from-pstn-reghours-4]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-reghours-nofax-4,s,1:2)    ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${INCOMING_4})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${INCOMING_4:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${INCOMING_4:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${INCOMING_4:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${INCOMING_4:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${INCOMING_4:4},1)
exten => s,21,Goto(${INCOMING_4},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-reghours-nofax-4]
exten => s,1,Set(intype=${INCOMING_4})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${INCOMING_4:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${INCOMING_4:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${INCOMING_4:8},1)
exten => s,9,GotoIf($["${intype}" = "QUE"]?10:13)                                     ; queue
exten => s,10,Answer                                                                ; answer call before queue
exten => s,11,Wait(1)
exten => s,12,Goto(ext-queues,${INCOMING_4:4},1)
exten => s,13,GotoIf($["${intype}" = "MIS"]?14:17)                                     ; queue
exten => s,14,Answer                                                                ; answer call before queue
exten => s,15,Wait(1)
exten => s,16,Goto(ext-miscdests,${INCOMING_4:4},1)
exten => s,17,Answer                                                                ; answer call before auto attendant
exten => s,18,Wait(1)
exten => s,19,Goto(${INCOMING_4},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-afthours-4]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-afthours-nofax-4,s,1:2)    ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${AFTER_INCOMING_4})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${AFTER_INCOMING_4:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${AFTER_INCOMING_4:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING_4:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${AFTER_INCOMING_4:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${AFTER_INCOMING_4:4},1)
exten => s,21,GotoIf($["${intype}" = "DIALFAX"]?22:24)
exten => s,22,Wait(3)
exten => s,23,Goto(ext-test,${AFTER_INCOMING_4:8},1)
exten => s,24,Goto(${AFTER_INCOMING_4},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-afthours-nofax-4]
exten => s,1,Set(intype=${AFTER_INCOMING_4})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${AFTER_INCOMING_4:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${AFTER_INCOMING_4:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${AFTER_INCOMING_4:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${AFTER_INCOMING_4:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING_4:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${AFTER_INCOMING_4:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${AFTER_INCOMING_4},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-holiday-4]
exten => s,1,Set(intype=${HOLIDAY_INCOMING_4})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${HOLIDAY_INCOMING_4:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${HOLIDAY_INCOMING_4:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${HOLIDAY_INCOMING_4:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${HOLIDAY_INCOMING_4:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${HOLIDAY_INCOMING_4:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${HOLIDAY_INCOMING_4:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${HOLIDAY_INCOMING_4},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

; ########################################################################################################
; FROM-PSTN-5
; ########################################################################################################

[from-pstn-5]
include => from-pstn-custom-5                                                       ; create this context in extensions_custom.conf to include customizations
include => ext-did
include => from-pstn-timecheck_5                                                    ; this has to be included otherwise it overrides ext-did
exten => fax,1,Goto(ext-fax,in_fax,1)

[from-pstn-timecheck_5]
exten => _X.,1,Goto(s,1)                                                            ; catch-all matching for calls that have DID info (if a DID route hasn't matched them)
exten => s,1,GotoIf($["${IN_OVERRIDE_5}" = "forcereghours" | "${DB(IN_OVERRIDE_6/INCOMING)}" ="forcereghours" ]?from-pstn-reghours-5,s,1:)
exten => s,2,GotoIf($["${IN_OVERRIDE_5}" = "forceafthours" | "${DB(IN_OVERRIDE_6/INCOMING)}" ="forceafthours" ]?from-pstn-afthours-5,s,1:)
exten => s,3,GotoIf($["${IN_OVERRIDE_5}" = "forceholiday" | "${DB(IN_OVERRIDE_6/INCOMING)}" ="forceholiday" ]?from-pstn-holiday-5,s,1:)

exten => s,4,GotoIf($["foo${REGTIME_5}foo${REGDAYS_5}foo${REGMONTHS_5}" = "foofoofoo"]?6:5)
exten => s,5,GotoIfTime(${REGTIME_5}|${REGDAYS_5}|*|${REGMONTHS_5}?from-pstn-reghours-5,s,1:)
exten => s,6,GotoIf($["foo${REGTIME2_5}foo${REGDAYS2_5}foo${REGMONTHS2_5}" = "foofoofoo"]?8:7)
exten => s,7,GotoIfTime(${REGTIME2_5}|${REGDAYS2_5}|*|${REGMONTHS2_5}?from-pstn-reghours-5,s,1:)
exten => s,8,GotoIf($["foo${REGTIME3_5}foo${REGDAYS3_5}foo${REGMONTHS3_5}" = "foofoofoo"]?10:9)
exten => s,9,GotoIfTime(${REGTIME3_5}|${REGDAYS3_5}|*|${REGMONTHS3_5}?from-pstn-reghours-5,s,1:)
exten => s,10,GotoIf($["foo${REGTIME4_5}foo${REGDAYS4_5}foo${REGMONTHS4_5}" = "foofoofoo"]?12:11)
exten => s,11,GotoIfTime(${REGTIME4_5}|${REGDAYS4_5}|*|${REGMONTHS4_5}?from-pstn-reghours-5,s,1:)

exten => s,12,Goto(from-pstn-afthours-5,s,1)

[from-pstn-reghours-5]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-reghours-nofax-5,s,1:2)    ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${INCOMING_5})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${INCOMING_5:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${INCOMING_5:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${INCOMING_5:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${INCOMING_5:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${INCOMING_5:4},1)
exten => s,21,Goto(${INCOMING_5},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-reghours-nofax-5]
exten => s,1,Set(intype=${INCOMING_5})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${INCOMING_5:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${INCOMING_5:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${INCOMING_5:8},1)
exten => s,9,GotoIf($["${intype}" = "QUE"]?10:13)                                     ; queue
exten => s,10,Answer                                                                ; answer call before queue
exten => s,11,Wait(1)
exten => s,12,Goto(ext-queues,${INCOMING_5:4},1)
exten => s,13,GotoIf($["${intype}" = "MIS"]?14:17)                                     ; queue
exten => s,14,Answer                                                                ; answer call before queue
exten => s,15,Wait(1)
exten => s,16,Goto(ext-miscdests,${INCOMING_5:4},1)
exten => s,17,Answer                                                                ; answer call before auto attendant
exten => s,18,Wait(1)
exten => s,19,Goto(${INCOMING_5},s,1)                                                 ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-afthours-5]
exten => s,1,GotoIf($["${FAX_RX}" = "disabled"]?from-pstn-afthours-nofax-5,s,1:2)    ; if fax detection is disabled, then jump to from-pstn-nofax - else continue
exten => s,2,Answer
exten => s,3,NVFaxDetect(3|dt)
exten => s,4,Set(intype=${AFTER_INCOMING_5})
exten => s,5,Set(intype=${CUT(intype,-,1)})
exten => s,6,GotoIf($["${intype}" = "EXT"]?7:9)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,7,Wait(3)                                                                 ; wait 3 more second to make sure this isn't a fax before dialing someone
exten => s,8,Goto(ext-local,${AFTER_INCOMING_5:4},1)
exten => s,9,GotoIf($["${intype}" = "GRP"]?10:12)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,10,Wait(3)
exten => s,11,Goto(ext-group,${AFTER_INCOMING_5:4},1)
exten => s,12,GotoIf($["${intype}" = "QUE"]?13:15)
exten => s,13,Wait(3)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING_5:4},1)
exten => s,15,GotoIf($["${intype}" = "DIALEXT"]?16:18)
exten => s,16,Wait(3)
exten => s,17,Goto(ext-local-dest,${AFTER_INCOMING_5:8},1)
exten => s,18,GotoIf($["${intype}" = "MIS"]?19:21)
exten => s,19,Wait(3)
exten => s,20,Goto(ext-miscdests,${AFTER_INCOMING_5:4},1)
exten => s,21,GotoIf($["${intype}" = "DIALFAX"]?22:24)
exten => s,22,Wait(3)
exten => s,23,Goto(ext-test,${AFTER_INCOMING_5:8},1)
exten => s,24,Goto(${AFTER_INCOMING_5},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => fax,1,Goto(ext-fax,in_fax,1)
exten => h,1,Hangup

[from-pstn-afthours-nofax-5]
exten => s,1,Set(intype=${AFTER_INCOMING_5})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${AFTER_INCOMING_5:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${AFTER_INCOMING_5:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${AFTER_INCOMING_5:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${AFTER_INCOMING_5:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${AFTER_INCOMING_5:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${AFTER_INCOMING_5:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${AFTER_INCOMING_5},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup

[from-pstn-holiday-5]
exten => s,1,Set(intype=${HOLIDAY_INCOMING_5})
exten => s,2,Set(intype=${CUT(intype,-,1)})
exten => s,3,GotoIf($["${intype}" = "EXT"]?4:5)                                        ; If INCOMING starts with EXT, then assume its an extension
exten => s,4,Goto(ext-local,${HOLIDAY_INCOMING_5:4},1)
exten => s,5,GotoIf($["${intype}" = "GRP"]?6:7)                                     ; If INCOMING starts with GRP, then assume its a ring group
exten => s,6,Goto(ext-group,${HOLIDAY_INCOMING_5:4},1)
exten => s,7,GotoIf($["${intype}" = "DIALEXT"]?8:9)                                 ; If INCOMING starts with DIALEXT, then assume its a ring group
exten => s,8,Goto(ext-local-dest,${HOLIDAY_INCOMING_5:8},1)
exten => s,9,GotoIf($["${intype}" = "DIALFAX"]?10:11)
exten => s,10,Goto(ext-test,${HOLIDAY_INCOMING_5:8},1)
exten => s,11,GotoIf($["${intype}" = "QUE"]?12:15)                                     ; queue
exten => s,12,Answer                                                                ; answer call before queue
exten => s,13,Wait(1)
exten => s,14,Goto(ext-queues,${HOLIDAY_INCOMING_5:4},1)
exten => s,15,GotoIf($["${intype}" = "MIS"]?16:19)                                     ; queue
exten => s,16,Answer                                                                ; answer call before queue
exten => s,17,Wait(1)
exten => s,18,Goto(ext-miscdests,${HOLIDAY_INCOMING_5:4},1)
exten => s,19,Answer                                                                ; answer call before auto attendant
exten => s,20,Wait(1)
exten => s,21,Goto(${HOLIDAY_INCOMING_5},s,1)                                             ; not EXT or GR1 - it's an auto attendant
exten => h,1,Hangup
